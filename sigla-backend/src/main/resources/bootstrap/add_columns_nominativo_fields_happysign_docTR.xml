<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (C) 2022  Consiglio Nazionale delle Ricerche
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
                                       http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet author="davide.mirra" id="add_columns_nominativo_fields_happysign_docTR">
        <addColumn tableName="doc_trasporto_rientro">
            <column name="nominativo_vettore" remarks="Nominativo del vettore che effettua il Trasporto/Rientro" type="VARCHAR(100)"/>
            <column name="id_flusso_happysign" remarks="ID del flusso di firma su HappySign" type="VARCHAR(100)"/>
            <column name="stato_flusso" remarks="Stato del flusso di firma. Dominio: INV=Inviato, FIR=Firmato, RIF=Rifiutato" type="VARCHAR(3)"/>
            <column name="data_invio_firma" remarks="Data invio al flusso di firma" type="${date.type}"/>
            <column name="data_firma" remarks="Data completamento firma" type="${date.type}"/>
            <column name="note_rifiuto" remarks="Note in caso di rifiuto firma" type="VARCHAR(2000)"/>
            <column name="cd_terzo_responsabile" remarks="Codice terzo del responsabile struttura (firmatario)" type="BIGINT"/>
        </addColumn>

        <!-- Aggiungi foreign key per cd_terzo_responsabile -->
        <addForeignKeyConstraint
                baseTableName="doc_trasporto_rientro"
                baseColumnNames="cd_terzo_responsabile"
                constraintName="fk_doc_t_r_resp_terzo"
                referencedTableName="terzo"
                referencedColumnNames="cd_terzo"
                deferrable="false"
                initiallyDeferred="false"
                onDelete="NO ACTION"
                onUpdate="NO ACTION"/>

        <!-- Aggiungi indice per stato_flusso per le query dello scheduler -->
        <createIndex indexName="idx_doc_t_r_stato_flusso" tableName="doc_trasporto_rientro">
            <column name="stato_flusso"/>
        </createIndex>

        <!-- Aggiungi indice per id_flusso_happysign -->
        <createIndex indexName="idx_doc_t_r_id_flusso" tableName="doc_trasporto_rientro">
            <column name="id_flusso_happysign"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>