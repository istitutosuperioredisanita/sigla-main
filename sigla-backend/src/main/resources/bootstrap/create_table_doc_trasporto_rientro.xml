<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (C) 2022  Consiglio Nazionale delle Ricerche
  ~
  ~     This program is free software: you can redistribute it and/or modify
  ~     it under the terms of the GNU Affero General Public License as
  ~     published by the Free Software Foundation, either version 3 of the
  ~     License, or (at your option) any later version.
  ~
  ~     This program is distributed in the hope that it will be useful,
  ~     but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~     GNU Affero General Public License for more details.
  ~
  ~     You should have received a copy of the GNU Affero General Public License
  ~     along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
                                       http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet author="davide.mirra" id="create_table_doc_trasporto_rientro">
        <createTable remarks="Lista delle testate dei documenti di trasporto e rientro insistenti sugli inventari" tableName="doc_trasporto_rientro">

            <column name="pg_inventario" remarks="Codice dell'inventario" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="ti_documento" remarks="Flag per stabilire se il documento risulta essere un trasporto o un rientro (T=Trasporto, R=Rientro)" type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column name="esercizio" remarks="Esercizio di riferimento" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="pg_doc_trasporto_rientro" remarks="Numero che identifica il documento di trasporto/rientro una volta noto inventario e esercizio" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="ds_doc_trasporto_rientro" remarks="Descrizione del documento di trasporto o rientro" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="data_registrazione" remarks="Data registrazione del documento" type="${date.type}">
                <constraints nullable="false"/>
            </column>
            <column name="cd_tipo_trasporto_rientro" remarks="Codice del tipo di movimento di trasporto/rientro di inventario" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="stato" remarks="Stato del documento. Dominio: INS = Inserito, PAF = Predisposto Alla Firma, DEF = Definitivo, ANN = Annullato" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>
            <column name="destinazione" remarks="Descrizione della destinazione del trasporto" type="VARCHAR(100)"/>
            <column name="indirizzo" remarks="Indirizzo completo della destinazione" type="VARCHAR(200)"/>

            <column name="fl_incaricato" remarks="Flag che indica se il ritiro è effettuato da un incaricato. Dominio: Y = Si, N = No. Esclusivo con FL_VETTORE." type="CHAR(1)" defaultValue="N">
                <constraints nullable="false"/>
            </column>
            <column name="fl_vettore" remarks="Flag che indica se il ritiro è effettuato da un vettore. Dominio: Y = Si, N = No. Esclusivo con FL_INCARICATO." type="CHAR(1)" defaultValue="N">
                <constraints nullable="false"/>
            </column>

            <column name="cd_terzo_assegnatario" remarks="Codice del terzo che rappresenta il dipendente incaricato del ritiro. Obbligatorio quando FL_INCARICATO = Y" type="BIGINT"/>
            <column name="note_ritiro" remarks="Note relative al ritiro del documento. Campo abilitato quando FL_INCARICATO o FL_VETTORE sono valorizzati a Y" type="VARCHAR(4000)"/>
            <column name="note" remarks="Note relative al documento di trasporto/rientro. Campo abilitato in base al flag FL_ABILITA_NOTE della tipologia" type="VARCHAR(4000)"/>

            <column name="dacr" remarks="Data di creazione del record" type="${date.type}">
                <constraints nullable="false"/>
            </column>
            <column name="utcr" remarks="Utenza di creazione del record" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="duva" remarks="Data di ultima variazione del record" type="${date.type}">
                <constraints nullable="false"/>
            </column>
            <column name="utuv" remarks="Utenza di ultima variazione del record" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="pg_ver_rec" remarks="Progressivo di versione del record: viene incrementato di 1 ad ogni variazione" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="ti_documento_rif" remarks="Tipo documento di riferimento" type="CHAR(1)"/>
            <column name="esercizio_rif" remarks="Esercizio di riferimento del documento collegato" type="INT"/>
            <column name="pg_doc_trasporto_rientro_rif" remarks="Numero documento di riferimento" type="INT"/>
        </createTable>

        <addPrimaryKey tableName="doc_trasporto_rientro" constraintName="doc_t_r_pkey"
                       columnNames="pg_inventario,ti_documento,esercizio,pg_doc_trasporto_rientro"/>

        <addForeignKeyConstraint baseTableName="doc_trasporto_rientro"
                                 baseColumnNames="cd_tipo_trasporto_rientro"
                                 constraintName="fk_doc_t_r01"
                                 referencedTableName="tipo_trasporto_rientro"
                                 referencedColumnNames="cd_tipo_trasporto_rientro"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="doc_trasporto_rientro"
                                 baseColumnNames="pg_inventario,ti_documento,esercizio"
                                 constraintName="fk_doc_t_r00"
                                 referencedTableName="numeratore_doc_t_r"
                                 referencedColumnNames="pg_inventario,ti_trasporto_rientro,esercizio"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="doc_trasporto_rientro"
                                 baseColumnNames="cd_terzo_assegnatario"
                                 constraintName="fk_doc_t_r_terzo"
                                 referencedTableName="terzo"
                                 referencedColumnNames="cd_terzo"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <addForeignKeyConstraint baseTableName="doc_trasporto_rientro"
                                 baseColumnNames="pg_inventario,ti_documento_rif,esercizio_rif,pg_doc_trasporto_rientro_rif"
                                 constraintName="doc_trasporto_rientro_fk1"
                                 referencedTableName="doc_trasporto_rientro"
                                 referencedColumnNames="pg_inventario,ti_documento,esercizio,pg_doc_trasporto_rientro"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"/>

        <createIndex indexName="fx_doc_t_r00" tableName="doc_trasporto_rientro">
            <column name="ti_documento"/>
            <column name="pg_inventario"/>
            <column name="esercizio"/>
        </createIndex>

        <createIndex indexName="fx_doc_t_r01" tableName="doc_trasporto_rientro">
            <column name="cd_tipo_trasporto_rientro"/>
        </createIndex>

        <createIndex indexName="fx_doc_t_r02" tableName="doc_trasporto_rientro">
            <column name="stato"/>
        </createIndex>

        <createIndex indexName="fx_doc_t_r_terzo" tableName="doc_trasporto_rientro">
            <column name="cd_terzo_assegnatario"/>
        </createIndex>

    </changeSet>
</databaseChangeLog>
