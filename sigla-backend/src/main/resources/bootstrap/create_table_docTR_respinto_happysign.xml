<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (C) 2023  Consiglio Nazionale delle Ricerche
  -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
                                       http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <!-- Unico changeset: crea sequence, tabella, FK e indici -->
    <changeSet author="davide.mirra" id="create_table_docTR_respinto_happysign">

        <!-- Sequence -->
        <createSequence
                sequenceName="seq_doc_trasporto_rientro_resp"
                startValue="1"
                incrementBy="1"/>

        <!-- Tabella -->
        <createTable remarks="Storico dei rifiuti dei documenti di trasporto e rientro"
                     tableName="doc_trasporto_rientro_respinto">

            <column name="id" remarks="Identificativo univoco del record" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="pg_inventario" remarks="Codice dell'inventario" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="ti_documento" remarks="Flag per stabilire se il documento risulta essere un trasporto o un rientro (T=Trasporto, R=Rientro)" type="CHAR(1)">
                <constraints nullable="false"/>
            </column>

            <column name="esercizio" remarks="Esercizio di riferimento" type="INT">
                <constraints nullable="false"/>
            </column>

            <column name="pg_doc_trasporto_rientro" remarks="Numero che identifica il documento di trasporto/rientro" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="data_inserimento" remarks="Data e ora di inserimento del record di rifiuto" type="${date.type}">
                <constraints nullable="false"/>
            </column>

            <column name="uid_insert" remarks="Utente che ha rifiutato il documento" type="VARCHAR(256)">
                <constraints nullable="false"/>
            </column>

            <column name="tipo_operazione_doc" remarks="Tipo di operazione: TR=Trasporto, RI=Rientro" type="VARCHAR(2)">
                <constraints nullable="false"/>
            </column>

            <column name="tipo_fase_respingi" remarks="Fase in cui Ã¨ avvenuto il rifiuto: RFI=Rifiuto Firma" type="VARCHAR(3)">
                <constraints nullable="false"/>
            </column>

            <column name="motivo_respingi" remarks="Motivazione del rifiuto" type="VARCHAR(2000)"/>

            <column name="dacr" remarks="Data di creazione del record" type="${date.type}">
                <constraints nullable="false"/>
            </column>

            <column name="utcr" remarks="Utenza di creazione del record" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="duva" remarks="Data di ultima variazione del record" type="${date.type}">
                <constraints nullable="false"/>
            </column>

            <column name="utuv" remarks="Utenza di ultima variazione del record" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="pg_ver_rec" remarks="Progressivo di versione del record" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <!-- Foreign key verso la tabella doc_trasporto_rientro -->
        <addForeignKeyConstraint
                baseTableName="doc_trasporto_rientro_respinto"
                baseColumnNames="pg_inventario,ti_documento,esercizio,pg_doc_trasporto_rientro"
                constraintName="fk_doc_t_r_resp_01"
                referencedTableName="doc_trasporto_rientro"
                referencedColumnNames="pg_inventario,ti_documento,esercizio,pg_doc_trasporto_rientro"
                deferrable="false"
                initiallyDeferred="false"
                onDelete="NO ACTION"
                onUpdate="NO ACTION"/>

        <!-- Indici -->
        <createIndex indexName="idx_doc_t_r_resp_01" tableName="doc_trasporto_rientro_respinto">
            <column name="pg_inventario"/>
            <column name="ti_documento"/>
            <column name="esercizio"/>
            <column name="pg_doc_trasporto_rientro"/>
        </createIndex>

        <createIndex indexName="idx_doc_t_r_resp_02" tableName="doc_trasporto_rientro_respinto">
            <column name="data_inserimento"/>
        </createIndex>

        <createIndex indexName="idx_doc_t_r_resp_03" tableName="doc_trasporto_rientro_respinto">
            <column name="uid_insert"/>
        </createIndex>

        <createIndex indexName="idx_doc_t_r_resp_04" tableName="doc_trasporto_rientro_respinto">
            <column name="tipo_operazione_doc"/>
        </createIndex>

    </changeSet>

</databaseChangeLog>
