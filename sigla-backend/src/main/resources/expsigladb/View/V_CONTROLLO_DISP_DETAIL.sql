CREATE OR REPLACE FORCE VIEW "V_CONTROLLO_DISP_DETAIL" ("CD_UNITA_ORGANIZZATIVA", "ESERCIZIO_OBBLIGAZIONE", "ESERCIZIO_ORI_OBBLIGAZIONE", "CD_CDS_OBBLIGAZIONE", "PG_OBBLIGAZIONE", "PG_OBBLIGAZIONE_SCADENZARIO", "TOT_ORDINE_IMPEGNO_STESSA_UO", "TOT_ORDINE_IMPEGNO_ALTRA_UO", "TOT_FATTURE_ORDINI", "TOT_FATTURE_NO_ORDINI", "TOT_COMPENSI", "TOT_DOCUMENTI_GENERICI", "TOT_MANDATI", "TOT_IMPEGNO_ASSOCIATO_DOCAMM", "TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM", "TOT_IMPEGNO_ASSOCIATO_DOCCONT", "TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT") AS
  SELECT o.CD_UNITA_ORGANIZZATIVA, oac.ESERCIZIO_OBBL ESERCIZIO_OBBLIGAZIONE, oac.ESERCIZIO_ORIG_OBBL ESERCIZIO_ORI_OBBLIGAZIONE, oac.CD_CDS_OBBL CD_CDS_OBBLIGAZIONE, oac.PG_OBBLIGAZIONE, oac.PG_OBBLIGAZIONE_SCAD PG_OBBLIGAZIONE_SCADENZARIO,
    	   CASE WHEN o.CD_UNITA_ORGANIZZATIVA = uoo.CD_UNITA_ORGANIZZATIVA
        	    THEN CASE WHEN oa.TI_ATTIVITA = 'C'
        	              THEN oac.IM_IMPONIBILE
        	              ELSE oac.IM_TOTALE_CONSEGNA
        	         END
        	    ELSE 0
           END TOT_ORDINE_IMPEGNO_STESSA_UO,
           CASE WHEN o.CD_UNITA_ORGANIZZATIVA != uoo.CD_UNITA_ORGANIZZATIVA
        	    THEN CASE WHEN oa.TI_ATTIVITA = 'C'
        	              THEN oac.IM_IMPONIBILE
        	    		  ELSE oac.IM_TOTALE_CONSEGNA
        	         END
        	    ELSE 0
           END TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   0 TOT_FATTURE_ORDINI,
		   0 TOT_FATTURE_NO_ORDINI,
		   0 TOT_COMPENSI,
		   0 TOT_DOCUMENTI_GENERICI,
		   0 TOT_MANDATI,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM ORDINE_ACQ_CONSEGNA oac
	LEFT JOIN ORDINE_ACQ oa ON oa.CD_CDS = oac.CD_CDS AND oa.ESERCIZIO = oac.ESERCIZIO AND oa.CD_UNITA_OPERATIVA = oac.CD_UNITA_OPERATIVA AND oa.CD_NUMERATORE = oac.CD_NUMERATORE AND oa.NUMERO = oac.NUMERO
	LEFT JOIN UNITA_OPERATIVA_ORD uoo ON uoo.CD_UNITA_OPERATIVA = oac.CD_UNITA_OPERATIVA
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = oac.ESERCIZIO_OBBL AND o.ESERCIZIO_ORIGINALE = oac.ESERCIZIO_ORIG_OBBL AND o.CD_CDS = oac.CD_CDS_OBBL AND o.PG_OBBLIGAZIONE = oac.PG_OBBLIGAZIONE
	WHERE oac.PG_OBBLIGAZIONE IS NOT NULL
	AND oac.STATO NOT IN ('ANN', 'EVF')
	AND o.CD_UNITA_ORGANIZZATIVA = uoo.CD_UNITA_ORGANIZZATIVA
	UNION ALL
	SELECT o.CD_UNITA_ORGANIZZATIVA uo, fpr.ESERCIZIO_OBBLIGAZIONE, fpr.ESERCIZIO_ORI_OBBLIGAZIONE, fpr.CD_CDS_OBBLIGAZIONE, fpr.PG_OBBLIGAZIONE, fpr.PG_OBBLIGAZIONE_SCADENZARIO,
	       0 TOT_ORDINE_IMPEGNO_STESSA_UO,
	       0 TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   CASE WHEN fo.CD_NUMERATORE IS NOT NULL AND oac.STATO NOT IN ('ANN', 'EVF')
		        THEN CASE WHEN fp.TI_ISTITUZ_COMMERC = 'I'
		                  THEN (nvl(fpr.IM_IMPONIBILE, 0) + nvl(fpr.IM_IVA, 0))*DECODE(fp.TI_FATTURA,'C',-1,1)
		                  ELSE nvl(fpr.IM_IMPONIBILE, 0)*DECODE(fp.TI_FATTURA,'C',-1,1)
		             END
		        ELSE 0
		   END TOT_FATTURE_ORDINI,
		   CASE WHEN fo.CD_NUMERATORE IS NULL OR oac.STATO IN ('ANN', 'EVF')
		        THEN CASE WHEN fp.TI_ISTITUZ_COMMERC = 'I'
		                  THEN (nvl(fpr.IM_IMPONIBILE, 0) + nvl(fpr.IM_IVA, 0))*DECODE(fp.TI_FATTURA,'C',-1,1)
		                  ELSE nvl(fpr.IM_IMPONIBILE, 0)*DECODE(fp.TI_FATTURA,'C',-1,1)
		             END
		        ELSE 0
		   END TOT_FATTURE_NO_ORDINI,
		   0 TOT_COMPENSI,
		   0 TOT_DOCUMENTI_GENERICI,
		   0 TOT_MANDATI,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM FATTURA_PASSIVA_RIGA fpr
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = fpr.ESERCIZIO_OBBLIGAZIONE AND o.ESERCIZIO_ORIGINALE = fpr.ESERCIZIO_ORI_OBBLIGAZIONE AND o.CD_CDS = fpr.CD_CDS_OBBLIGAZIONE AND o.PG_OBBLIGAZIONE = fpr.PG_OBBLIGAZIONE
	LEFT JOIN OBBLIGAZIONE_SCADENZARIO os ON os.ESERCIZIO = fpr.ESERCIZIO_OBBLIGAZIONE AND os.ESERCIZIO_ORIGINALE = fpr.ESERCIZIO_ORI_OBBLIGAZIONE AND os.CD_CDS = fpr.CD_CDS_OBBLIGAZIONE AND os.PG_OBBLIGAZIONE = fpr.PG_OBBLIGAZIONE AND os.PG_OBBLIGAZIONE_SCADENZARIO = fpr.PG_OBBLIGAZIONE_SCADENZARIO
	LEFT JOIN FATTURA_PASSIVA fp ON fp.ESERCIZIO = fpr.ESERCIZIO AND fp.CD_CDS = fpr.CD_CDS AND fp.CD_UNITA_ORGANIZZATIVA = fpr.CD_UNITA_ORGANIZZATIVA AND fp.PG_FATTURA_PASSIVA = fpr.PG_FATTURA_PASSIVA
	LEFT JOIN FATTURA_ORDINE fo ON fo.ESERCIZIO = fpr.ESERCIZIO AND fo.CD_CDS = fpr.CD_CDS AND fo.CD_UNITA_ORGANIZZATIVA = fpr.CD_UNITA_ORGANIZZATIVA AND fo.PG_FATTURA_PASSIVA = fpr.PG_FATTURA_PASSIVA AND fo.PROGRESSIVO_RIGA = fpr.PROGRESSIVO_RIGA
	LEFT JOIN ORDINE_ACQ_CONSEGNA oac ON oac.CD_CDS = fo.CD_CDS_ORDINE AND oac.CD_UNITA_OPERATIVA = fo.CD_UNITA_OPERATIVA AND oac.ESERCIZIO = fo.ESERCIZIO_ORDINE AND oac.CD_NUMERATORE = fo.CD_NUMERATORE AND oac.NUMERO = fo.NUMERO AND oac.RIGA = fo.RIGA AND oac.CONSEGNA = fo.CONSEGNA
	WHERE fpr.PG_OBBLIGAZIONE IS NOT NULL
	AND   fpr.STATO_COFI != 'A'
	AND   (fp.PG_LETTERA IS NULL OR os.IM_SCADENZA = 0)
	UNION ALL
	SELECT DISTINCT o.CD_UNITA_ORGANIZZATIVA uo, fpr.ESERCIZIO_OBBLIGAZIONE, fpr.ESERCIZIO_ORI_OBBLIGAZIONE, fpr.CD_CDS_OBBLIGAZIONE, fpr.PG_OBBLIGAZIONE, fpr.PG_OBBLIGAZIONE_SCADENZARIO,
	       0 TOT_ORDINE_IMPEGNO_STESSA_UO,
	       0 TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   CASE WHEN fo.CD_NUMERATORE IS NOT NULL
		        THEN os.IM_SCADENZA
		        ELSE 0
		   END TOT_FATTURE_ORDINI,
		   CASE WHEN fo.CD_NUMERATORE IS NULL
		        THEN os.IM_SCADENZA
		        ELSE 0
		   END TOT_FATTURE_NO_ORDINI,
		   0 TOT_COMPENSI,
		   0 TOT_DOCUMENTI_GENERICI,
		   0 TOT_MANDATI,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM FATTURA_PASSIVA_RIGA fpr
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = fpr.ESERCIZIO_OBBLIGAZIONE AND o.ESERCIZIO_ORIGINALE = fpr.ESERCIZIO_ORI_OBBLIGAZIONE AND o.CD_CDS = fpr.CD_CDS_OBBLIGAZIONE AND o.PG_OBBLIGAZIONE = fpr.PG_OBBLIGAZIONE
	LEFT JOIN OBBLIGAZIONE_SCADENZARIO os ON os.ESERCIZIO = fpr.ESERCIZIO_OBBLIGAZIONE AND os.ESERCIZIO_ORIGINALE = fpr.ESERCIZIO_ORI_OBBLIGAZIONE AND os.CD_CDS = fpr.CD_CDS_OBBLIGAZIONE AND os.PG_OBBLIGAZIONE = fpr.PG_OBBLIGAZIONE AND os.PG_OBBLIGAZIONE_SCADENZARIO = fpr.PG_OBBLIGAZIONE_SCADENZARIO
	LEFT JOIN FATTURA_PASSIVA fp ON fp.ESERCIZIO = fpr.ESERCIZIO AND fp.CD_CDS = fpr.CD_CDS AND fp.CD_UNITA_ORGANIZZATIVA = fpr.CD_UNITA_ORGANIZZATIVA AND fp.PG_FATTURA_PASSIVA = fpr.PG_FATTURA_PASSIVA
	LEFT JOIN FATTURA_ORDINE fo ON fo.ESERCIZIO = fpr.ESERCIZIO AND fo.CD_CDS = fpr.CD_CDS AND fo.CD_UNITA_ORGANIZZATIVA = fpr.CD_UNITA_ORGANIZZATIVA AND fo.PG_FATTURA_PASSIVA = fpr.PG_FATTURA_PASSIVA AND fo.PROGRESSIVO_RIGA = fpr.PROGRESSIVO_RIGA
	WHERE fpr.PG_OBBLIGAZIONE IS NOT NULL
	AND   fpr.STATO_COFI != 'A'
	AND   fp.PG_LETTERA IS NOT NULL
	AND   os.IM_SCADENZA != 0
	UNION ALL
	SELECT o.CD_UNITA_ORGANIZZATIVA, cmp.ESERCIZIO_OBBLIGAZIONE, cmp.ESERCIZIO_ORI_OBBLIGAZIONE, cmp.CD_CDS_OBBLIGAZIONE, cmp.PG_OBBLIGAZIONE, cmp.PG_OBBLIGAZIONE_SCADENZARIO,
	       0 TOT_ORDINE_IMPEGNO_STESSA_UO,
	       0 TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   0 TOT_FATTURE_ORDINI,
		   0 TOT_FATTURE_NO_ORDINI,
		   NVL(cmp.IM_TOTALE_COMPENSO, 0) TOT_COMPENSI,
		   0 TOT_DOCUMENTI_GENERICI,
		   0 TOT_MANDATI,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM COMPENSO cmp
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = cmp.ESERCIZIO_OBBLIGAZIONE AND o.ESERCIZIO_ORIGINALE = cmp.ESERCIZIO_ORI_OBBLIGAZIONE AND o.CD_CDS = cmp.CD_CDS_OBBLIGAZIONE AND o.PG_OBBLIGAZIONE = cmp.PG_OBBLIGAZIONE
	WHERE cmp.PG_OBBLIGAZIONE IS NOT NULL
	AND   cmp.STATO_COFI != 'A'
	UNION ALL
	SELECT o.CD_UNITA_ORGANIZZATIVA, dgr.ESERCIZIO_OBBLIGAZIONE, dgr.ESERCIZIO_ORI_OBBLIGAZIONE, dgr.CD_CDS_OBBLIGAZIONE, dgr.PG_OBBLIGAZIONE, dgr.PG_OBBLIGAZIONE_SCADENZARIO,
	       0 TOT_ORDINE_IMPEGNO_STESSA_UO,
	       0 TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   0 TOT_FATTURE_ORDINI,
		   0 TOT_FATTURE_NO_ORDINI,
		   0 TOT_COMPENSI,
		   NVL(dgr.IM_RIGA, 0)*DECODE(dg.FL_STORNO,'Y',-1,1) TOT_DOCUMENTI_GENERICI,
		   0 TOT_MANDATI,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM DOCUMENTO_GENERICO_RIGA dgr
	LEFT JOIN DOCUMENTO_GENERICO dg ON dg.CD_CDS = dgr.CD_CDS AND dg.CD_UNITA_ORGANIZZATIVA = dgr.CD_UNITA_ORGANIZZATIVA AND dg.ESERCIZIO = dgr.ESERCIZIO AND dg.CD_TIPO_DOCUMENTO_AMM = dgr.CD_TIPO_DOCUMENTO_AMM AND dg.PG_DOCUMENTO_GENERICO = dgr.PG_DOCUMENTO_GENERICO
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = dgr.ESERCIZIO_OBBLIGAZIONE AND o.ESERCIZIO_ORIGINALE = dgr.ESERCIZIO_ORI_OBBLIGAZIONE AND o.CD_CDS = dgr.CD_CDS_OBBLIGAZIONE AND o.PG_OBBLIGAZIONE = dgr.PG_OBBLIGAZIONE
	WHERE dgr.PG_OBBLIGAZIONE IS NOT NULL
	AND   dg.STATO_COFI != 'A'
	UNION ALL
	SELECT o.CD_UNITA_ORGANIZZATIVA, mr.ESERCIZIO_OBBLIGAZIONE, mr.ESERCIZIO_ORI_OBBLIGAZIONE, mr.CD_CDS, mr.PG_OBBLIGAZIONE, mr.PG_OBBLIGAZIONE_SCADENZARIO,
	       0 TOT_ORDINE_IMPEGNO_STESSA_UO,
	       0 TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   0 TOT_FATTURE_ORDINI,
		   0 TOT_FATTURE_NO_ORDINI,
		   0 TOT_COMPENSI,
		   0 TOT_DOCUMENTI_GENERICI,
		   NVL(mr.IM_MANDATO_RIGA, 0) TOT_MANDATI,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   0 TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   0 TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM MANDATO_RIGA mr
	LEFT JOIN MANDATO m ON m.CD_CDS = mr.CD_CDS AND m.ESERCIZIO = mr.ESERCIZIO AND m.PG_MANDATO = mr.PG_MANDATO
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = mr.ESERCIZIO_OBBLIGAZIONE AND o.ESERCIZIO_ORIGINALE = mr.ESERCIZIO_ORI_OBBLIGAZIONE AND o.CD_CDS = mr.CD_CDS AND o.PG_OBBLIGAZIONE = mr.PG_OBBLIGAZIONE
	WHERE mr.PG_OBBLIGAZIONE IS NOT NULL
	AND   m.STATO != 'A'
	UNION ALL
	SELECT o.CD_UNITA_ORGANIZZATIVA, os.ESERCIZIO, os.ESERCIZIO_ORIGINALE, os.CD_CDS, os.PG_OBBLIGAZIONE, os.PG_OBBLIGAZIONE_SCADENZARIO,
	       0 TOT_ORDINE_IMPEGNO_STESSA_UO,
	       0 TOT_ORDINE_IMPEGNO_ALTRA_UO,
		   0 TOT_FATTURE_ORDINI,
		   0 TOT_FATTURE_NO_ORDINI,
		   0 TOT_COMPENSI,
		   0 TOT_DOCUMENTI_GENERICI,
		   0 TOT_MANDATI,
		   CASE WHEN os.IM_ASSOCIATO_DOC_AMM > 0
		        THEN nvl(os.IM_ASSOCIATO_DOC_AMM, 0)
		        ELSE 0
		   END TOT_IMPEGNO_ASSOCIATO_DOCAMM,
		   CASE WHEN os.IM_ASSOCIATO_DOC_AMM = 0
		        THEN nvl(os.IM_SCADENZA, 0)
		        ELSE 0
		   END TOT_IMPEGNO_DA_ASSOCIARE_DOCAMM,
		   CASE WHEN os.IM_ASSOCIATO_DOC_CONTABILE > 0
		        THEN nvl(os.IM_ASSOCIATO_DOC_CONTABILE, 0)
		        ELSE 0
		   END TOT_IMPEGNO_ASSOCIATO_DOCCONT,
		   CASE WHEN os.IM_ASSOCIATO_DOC_CONTABILE = 0
		        THEN nvl(os.IM_SCADENZA, 0)
		        ELSE 0
		   END TOT_IMPEGNO_DA_ASSOCIARE_DOCCONT
	FROM OBBLIGAZIONE_SCADENZARIO os
	LEFT JOIN OBBLIGAZIONE o ON o.ESERCIZIO = os.ESERCIZIO AND o.ESERCIZIO_ORIGINALE = os.ESERCIZIO_ORIGINALE AND o.CD_CDS = os.CD_CDS AND o.PG_OBBLIGAZIONE = os.PG_OBBLIGAZIONE
   	WHERE os.IM_ASSOCIATO_DOC_CONTABILE > 0 OR (o.ESERCIZIO, o.ESERCIZIO_ORIGINALE, o.CD_CDS, o.PG_OBBLIGAZIONE) IN
       	(SELECT DISTINCT (SELECT MAX(A.ESERCIZIO) FROM OBBLIGAZIONE A
       	                  WHERE A.ESERCIZIO_ORIGINALE = B.ESERCIZIO_ORIGINALE
       	                  AND A.CD_CDS=B.CD_CDS
       	                  AND A.PG_OBBLIGAZIONE=B.PG_OBBLIGAZIONE) ESERCIZIO,
                B.ESERCIZIO_ORIGINALE, B.CD_CDS, B.PG_OBBLIGAZIONE
        FROM OBBLIGAZIONE B);